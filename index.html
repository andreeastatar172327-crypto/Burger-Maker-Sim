<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Clicker Sim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #e6e6e6; /* Light text */
        }
        .main-miner-button {
            transition: transform 0.1s ease-out;
            box-shadow: 0 4px 15px rgba(0, 255, 128, 0.4);
            background: linear-gradient(145deg, #10b981, #059669); /* Teal/Emerald gradient */
            border: 3px solid #065f46;
        }
        .main-miner-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(0, 255, 128, 0.6);
        }
        .upgrade-card {
            background-color: #161b22;
            border: 1px solid #30363d;
            transition: all 0.2s;
        }
        .upgrade-card:hover {
            background-color: #1f242c;
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level (Debug for development)
        setLogLevel('Debug');

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- Game State Variables ---
        let state = {
            balance: 0, // Current crypto balance
            hashRate: 1.0, // Crypto per second (CPS)
            clickPower: 1.0, // Crypto per click (CPC)
            upgradeLevels: {}, // { upgradeId: level }
        };

        const UPGRADES = [
            // CPC Upgrades
            { id: 'gpu', name: 'GPU Mining Rig', type: 'CPS', baseCost: 10, baseHash: 1.0, multiplier: 1.15, costFactor: 1.25, icon: 'âš¡' },
            { id: 'asic', name: 'ASIC Chip Cluster', type: 'CPS', baseCost: 1000, baseHash: 10.0, multiplier: 1.15, costFactor: 1.3, icon: 'ðŸ–¥ï¸' },
            { id: 'farm', name: 'Hyperscale Data Center', type: 'CPS', baseCost: 100000, baseHash: 1000.0, multiplier: 1.15, costFactor: 1.5, icon: 'ðŸ­' },

            // CPS Upgrades
            { id: 'mouse', name: 'Quantum Mouse', type: 'CPC', baseCost: 50, baseHash: 1.0, multiplier: 1.15, costFactor: 1.2, icon: 'ðŸ–±ï¸' },
            { id: 'tap', name: 'Neural Tap Interface', type: 'CPC', baseCost: 5000, baseHash: 50.0, multiplier: 1.15, costFactor: 1.4, icon: 'ðŸ§ ' },
        ];


        // --- Firebase Functions ---
        const getDocRef = (uid) => doc(db, `artifacts/${appId}/users/${uid}/crypto_sim_data`, 'game_state');

        const saveGame = async () => {
            if (!userId) return;
            try {
                const docRef = getDocRef(userId);
                // Save only the essential state data
                await setDoc(docRef, {
                    balance: state.balance,
                    hashRate: state.hashRate,
                    clickPower: state.clickPower,
                    upgradeLevels: state.upgradeLevels,
                    lastSave: new Date().toISOString(),
                });
                console.log("Game state saved successfully.");
            } catch (e) {
                console.error("Error saving game state: ", e);
            }
        };

        const loadGame = () => {
            if (!userId) return;

            const docRef = getDocRef(userId);
            // Listen for real-time updates (if another device updates the game)
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    state.balance = loadedData.balance || 0;
                    state.hashRate = loadedData.hashRate || 1.0;
                    state.clickPower = loadedData.clickPower || 1.0;
                    state.upgradeLevels = loadedData.upgradeLevels || {};
                    console.log("Game state loaded in real-time:", state);
                    updateUI(); // Force UI update on load
                } else {
                    console.log("No saved game state found, starting new game.");
                    updateUI(); // Update UI with initial state
                }
            }, (error) => {
                console.error("Error listening to game state:", error);
            });
        };

        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Cannot initialize Firestore.");
                document.getElementById('status').textContent = "Error: Firebase configuration missing.";
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be finalized
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        loadGame(); // Start listening for data
                        startGameLoop(); // Start passive income
                    } else {
                        console.log("No user signed in.");
                        document.getElementById('status').textContent = "Signed out.";
                        isAuthReady = true; // Still ready, just anonymous/signed out
                        startGameLoop();
                    }
                });

            } catch (e) {
                console.error("Firebase initialization or authentication failed:", e);
                document.getElementById('status').textContent = `Auth Error: ${e.message}`;
            }
        };


        // --- Game Logic Functions ---

        const formatNumber = (num) => {
            if (num === 0) return '0.00';
            if (num < 1000) return num.toFixed(2);
            const units = ['', 'K', 'M', 'B', 'T', 'Q'];
            const exponent = Math.floor(Math.log(num) / Math.log(1000));
            return (num / Math.pow(1000, exponent)).toFixed(2) + units[exponent];
        };

        window.clickCrypto = () => {
            state.balance += state.clickPower;
            updateUI();

            // Floating text feedback (visual candy)
            const clickText = document.createElement('div');
            clickText.textContent = `+${formatNumber(state.clickPower)}`;
            clickText.className = 'absolute text-green-400 font-bold opacity-0 transition-all duration-700 ease-out pointer-events-none';
            clickText.style.left = `${Math.random() * 80 + 10}%`;
            clickText.style.top = '50%';
            
            const clickArea = document.getElementById('click-area');
            clickArea.appendChild(clickText);

            // Trigger animation
            setTimeout(() => {
                clickText.classList.remove('opacity-0');
                clickText.style.transform = 'translateY(-50px) scale(1.2)';
            }, 10);

            // Remove element after animation
            setTimeout(() => {
                clickArea.removeChild(clickText);
            }, 700);
        };

        window.buyUpgrade = (upgradeId) => {
            const upgrade = UPGRADES.find(u => u.id === upgradeId);
            if (!upgrade) return;

            const currentLevel = state.upgradeLevels[upgradeId] || 0;
            const cost = calculateCost(upgrade, currentLevel);

            if (state.balance >= cost) {
                state.balance -= cost;
                state.upgradeLevels[upgradeId] = currentLevel + 1;

                // Recalculate total hash rate and click power
                calculateTotalStats();

                updateUI();
                saveGame(); // Save after successful purchase
            } else {
                console.log("Not enough balance.");
                showNotification("Insufficient Funds!", 'bg-red-600');
            }
        };

        const calculateCost = (upgrade, level) => {
            // Cost = BaseCost * (CostFactor ^ Level)
            return Math.floor(upgrade.baseCost * Math.pow(upgrade.costFactor, level));
        };

        const calculateTotalStats = () => {
            let newHashRate = 1.0; // Base CPS
            let newClickPower = 1.0; // Base CPC

            for (const upgrade of UPGRADES) {
                const level = state.upgradeLevels[upgrade.id] || 0;
                if (level > 0) {
                    // Total increase = BaseIncrease * (Multiplier ^ (Level - 1))
                    const totalIncrease = upgrade.baseHash * Math.pow(upgrade.multiplier, level - 1) * level;

                    if (upgrade.type === 'CPS') {
                        newHashRate += totalIncrease;
                    } else if (upgrade.type === 'CPC') {
                        newClickPower += totalIncrease;
                    }
                }
            }
            state.hashRate = newHashRate;
            state.clickPower = newClickPower;
        };

        const updateUI = () => {
            // 1. Update Header Stats
            document.getElementById('balance-display').textContent = formatNumber(state.balance);
            document.getElementById('hashrate-display').textContent = formatNumber(state.hashRate);
            document.getElementById('clickpower-display').textContent = formatNumber(state.clickPower);

            // 2. Update Upgrades List
            const upgradesContainer = document.getElementById('upgrades-container');
            upgradesContainer.innerHTML = ''; // Clear existing content

            UPGRADES.forEach(upgrade => {
                const currentLevel = state.upgradeLevels[upgrade.id] || 0;
                const nextCost = calculateCost(upgrade, currentLevel);
                const nextIncrease = upgrade.baseHash * Math.pow(upgrade.multiplier, currentLevel);

                const canAfford = state.balance >= nextCost;
                const buttonClass = canAfford ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-gray-700 cursor-not-allowed opacity-50';

                const card = `
                    <div class="upgrade-card p-4 rounded-xl flex justify-between items-center w-full mb-3" onclick="${canAfford ? `buyUpgrade('${upgrade.id}')` : 'showNotification(\'Insufficient Funds!\', \'bg-red-600\')'}">
                        <div class="flex items-center">
                            <div class="text-3xl mr-4">${upgrade.icon}</div>
                            <div>
                                <p class="text-lg font-semibold">${upgrade.name} (Lvl ${currentLevel})</p>
                                <p class="text-sm text-gray-400">
                                    Adds +${formatNumber(nextIncrease)} ${upgrade.type}.
                                </p>
                            </div>
                        </div>
                        <button class="px-4 py-2 text-white font-bold rounded-lg ${buttonClass}">
                            BUY: ${formatNumber(nextCost)} ðŸ’Ž
                        </button>
                    </div>
                `;
                upgradesContainer.insertAdjacentHTML('beforeend', card);
            });
        };

        const gameLoop = () => {
            // Add passive income
            state.balance += state.hashRate / 10; // Divided by 10 because loop runs every 100ms (10 times per second)

            // Save game periodically (e.g., every 60 seconds of the loop = 600 iterations)
            if (isAuthReady && gameLoop.saveCounter % 600 === 0) {
                 saveGame();
            }
            gameLoop.saveCounter++;

            updateUI();
        };
        gameLoop.saveCounter = 0; // Initialize counter

        const startGameLoop = () => {
            setInterval(gameLoop, 100); // 10 times per second
        };

        const showNotification = (message, className) => {
            const notification = document.getElementById('notification-box');
            notification.textContent = message;
            notification.className = `fixed top-5 left-1/2 -translate-x-1/2 p-3 rounded-xl text-white font-bold transition-opacity duration-300 z-50 ${className}`;
            notification.style.opacity = '1';

            setTimeout(() => {
                notification.style.opacity = '0';
            }, 1500);
        }

        // --- Initialization ---
        window.onload = initFirebase;

    </script>

    <!-- Notification Box -->
    <div id="notification-box" class="opacity-0"></div>
    
    <!-- Main Content Container (Mobile-First) -->
    <div class="w-full max-w-md mx-auto">

        <!-- Header and Stats -->
        <header class="text-center py-6 border-b border-gray-700 mb-6">
            <h1 class="text-3xl font-extrabold text-emerald-400 mb-1">Crypto Clicker Sim</h1>
            <p id="user-id-display" class="text-xs text-gray-500 mb-4 truncate">Loading User...</p>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <div class="text-xl font-bold text-gray-300">
                    <span id="balance-display">0.00</span> ðŸ’Ž
                </div>
                <p class="text-sm text-gray-500 mb-4">Current Balance</p>

                <div class="flex justify-around text-center text-sm">
                    <div>
                        <p class="font-semibold text-emerald-400" id="hashrate-display">1.0</p>
                        <p class="text-gray-500">Hash/s (CPS)</p>
                    </div>
                    <div>
                        <p class="font-semibold text-emerald-400" id="clickpower-display">1.0</p>
                        <p class="text-gray-500">Click Power (CPC)</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Mining Area -->
        <div id="click-area" class="relative flex justify-center items-center mb-8 h-48">
            <button class="main-miner-button w-40 h-40 flex items-center justify-center rounded-full text-white text-2xl font-black"
                    onclick="clickCrypto()">
                MINE
            </button>
        </div>

        <!-- Upgrades Section -->
        <h2 class="text-xl font-semibold mb-3 text-gray-300 border-b border-gray-700 pb-2">Mining Upgrades</h2>
        <div id="upgrades-container" class="space-y-3">
            <!-- Upgrades will be dynamically inserted here by updateUI() -->
            <p class="text-center text-gray-500">Loading upgrades...</p>
        </div>
        
        <p id="status" class="text-center text-xs text-gray-600 mt-6">Initializing Firebase...</p>

    </div>

</body>
</html>

